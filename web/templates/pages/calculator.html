{{ define "custom_head" }}
<head>
  <title>Calculadora - PoliPlanner</title>
</head>
{{ end }}

{{ define "content" }}
<main>
  <h1 class="title is-3">Calculadora de Notas</h1>
  <section class="box mb-5">
    <h3 class="title is-4">A) Ya tengo mi promedio ponderado</h3>
    <p class="mb-3">
      Ingresa tu promedio ponderado (0–100) y obtén los puntajes mínimos del examen final para cada nota 2–5.
    </p>
    <form id="formPonderado" onsubmit="return false;">
      <div class="field">
        <label class="label" for="inputPonderado">Promedio ponderado (0–100)</label>
        <div class="control">
          <input class="input" type="number" id="inputPonderado" min="0" max="100" step="1">
        </div>
      </div>
      <button id="btnPonderado" type="button" class="button is-link">Calcular</button>
    </form>
  </section>
  <section class="box mb-5">
    <h3 class="title is-4">B) Calcular promedio ponderado y examen</h3>
    <p class="mb-3">
      Introduce tus promedios y pesos (que sumen 100) para calcular tu promedio ponderado y los puntajes del examen.
    </p>
    <form id="formComponentes" onsubmit="return false;">
      <div class="columns is-multiline">
        <div class="column is-4">
          <label class="label" for="pesoParciales">Peso Parciales (%)</label>
          <input class="input" type="number" id="pesoParciales" min="0" max="100" value="0">
          <label class="label mt-3" for="promParciales">Promedio Parciales (0–100)</label>
          <input class="input" type="number" id="promParciales" min="0" max="100" value="0">
        </div>
        <div class="column is-4">
          <label class="label" for="pesoTareas">Peso Tareas (%)</label>
          <input class="input" type="number" id="pesoTareas" min="0" max="100" value="0">
          <label class="label mt-3" for="promTareas">Promedio Tareas (0–100)</label>
          <input class="input" type="number" id="promTareas" min="0" max="100" value="0">
        </div>
        <div class="column is-4">
          <label class="label" for="pesoLab">Peso Laboratorios (%)</label>
          <input class="input" type="number" id="pesoLab" min="0" max="100" value="0">
          <label class="label mt-3" for="promLab">Promedio Lab. (0–100)</label>
          <input class="input" type="number" id="promLab" min="0" max="100" value="0">
        </div>
      </div>
      <button id="btnComponentes" type="button" class="button is-link mt-2">Calcular</button>
    </form>
  </section>
  <section id="resultados" class="box">
    <h3 class="title is-4">Puntajes mínimos requeridos</h3>
    <div class="table-container">
      <table class="table is-fullwidth is-striped is-hoverable">
        <thead>
          <tr>
            <th>Nota final</th>
            <th>Puntaje requerido</th>
          </tr>
        </thead>
        <tbody id="resultadoTabla"></tbody>
      </table>
    </div>
  </section>
  <section class="mt-5">
    Si quieres saber cómo se calculan las notas puedes visitar la guía de 
    <a class="has-text-link" href="/guides/calculo_notas">Cálculo de Notas</a>.
  </section>
  <script>
    const MIN_EXAM = 50;

    const UMBRALES_NOTAS = [
        { min: 91, nota: 5 },
        { min: 81, nota: 4 },
        { min: 71, nota: 3 },
        { min: 60, nota: 2 },
    ];

    function calcularNotaFinal(ponderado, examen) {
        const puntajeFinal = 0.4 * ponderado + 0.6 * examen;
        for (const u of UMBRALES_NOTAS) {
            if (puntajeFinal >= u.min) return u.nota;
        }
        return 1;
    }

    function calcularExamenNecesario(ponderado, notaDeseada) {
        const u = UMBRALES_NOTAS.find(x => x.nota === notaDeseada);
        if (!u) return NaN;

        let examen = (u.min - 0.4 * ponderado) / 0.6;
        examen = Math.max(examen, MIN_EXAM);
        examen = Math.floor(examen);
        return examen > 100 ? '-' : examen;
    }

    function calcularTabla(ponderado) {
        const tbody = document.getElementById('resultadoTabla');
        tbody.innerHTML = '';

        for (let n = 5; n >= 2; n--) {
            const req = calcularExamenNecesario(ponderado, n);
            tbody.insertAdjacentHTML('beforeend', `
    <tr>
    <td>${n}</td>
    <td>${req}</td>
    </tr>
    `);
        }

        document.getElementById('resultados')
            .scrollIntoView({ behavior: 'smooth' });
    }

    document.getElementById('btnPonderado').onclick = () => {
        const v = parseInt(document.getElementById('inputPonderado').value);
        if (isNaN(v) || v < 0 || v > 100) {
            alert('Ingresa un promedio válido (0–100)');
            return;
        }
        calcularTabla(v);
    };

    document.getElementById('btnComponentes').onclick = () => {
        const p1 = parseInt(document.getElementById('pesoParciales').value) || 0;
        const p2 = parseInt(document.getElementById('pesoTareas').value) || 0;
        const p3 = parseInt(document.getElementById('pesoLab').value) || 0;

        if (p1 + p2 + p3 !== 100) {
            alert('La suma de los pesos debe ser 100');
            return;
        }

        const m1 = parseInt(document.getElementById('promParciales').value);
        const m2 = parseInt(document.getElementById('promTareas').value);
        const m3 = parseInt(document.getElementById('promLab').value);

        if ([m1, m2, m3].some(x => isNaN(x) || x < 0 || x > 100)) {
            alert('Promedios deben ser números entre 0 y 100');
            return;
        }

        const ponderado = (m1 * p1 + m2 * p2 + m3 * p3) / 100;
        calcularTabla(ponderado);
    };
  </script>
</main>
{{ end }}
