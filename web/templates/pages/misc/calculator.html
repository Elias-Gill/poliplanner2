{{ define "custom_head" }}
<head>
  <title>Calculadora - PoliPlanner</title>
</head>
{{ end }}
{{ define "content" }}
<main class="calc-root">
  <h1>Calculadora de Notas</h1>
  <!-- OPCIÓN A -->
  <article>
    <h2>A) Ya tengo mi promedio ponderado</h2>
    <p>
      Ingresa tu promedio ponderado y calcula qué puntaje necesitas en el examen final.
    </p>
    <form onsubmit="return false;">
      <div class="calc-group">
        <label for="inputPonderado">Promedio ponderado (40–100)</label>
        <input type="number" id="inputPonderado" min="0" max="100" step="1">
      </div>
      <button type="button" id="btnPonderado" class="calc-btn">
        Calcular
      </button>
    </form>
  </article>
  <!-- OPCIÓN B -->
  <article>
    <h2>B) Armar tu promedio ponderado</h2>
    <p>Los pesos deben sumar 100%.</p>
    <form onsubmit="return false;">
      <fieldset class="calc-block">
        <legend class="calc-legend">Parciales</legend>
        <div class="calc-row">
          <div class="calc-group">
            <label>Parcial 1</label>
            <input type="number" id="notaP1" min="0" max="100">
          </div>
          <div class="calc-group">
            <label>Parcial 2</label>
            <input type="number" id="notaP2" min="0" max="100">
          </div>
          <div class="calc-group">
            <label>Peso (%)</label>
            <input type="number" id="pesoParciales" min="0" max="100">
          </div>
        </div>
      </fieldset>
      <fieldset class="calc-block">
        <legend class="calc-legend">Otras evaluaciones</legend>
        <div class="calc-row">
          <div class="calc-group">
            <label>Tareas / Trabajos</label>
            <input type="number" id="notaT" min="0" max="100">
          </div>
          <div class="calc-group">
            <label>Peso (%)</label>
            <input type="number" id="pesoT" min="0" max="100">
          </div>
        </div>
        <div class="calc-row">
          <div class="calc-group">
            <label>Laboratorio</label>
            <input type="number" id="notaL" min="0" max="100">
          </div>
          <div class="calc-group">
            <label>Peso (%)</label>
            <input type="number" id="pesoL" min="0" max="100">
          </div>
        </div>
      </fieldset>
      <button type="button" id="btnComponentes" class="calc-btn">
        Calcular
      </button>
    </form>
  </article>
  <!-- RESULTADOS -->
  <article id="resultados">
    <h2>Puntajes mínimos requeridos</h2>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Nota final</th>
            <th>Puntaje necesario</th>
          </tr>
        </thead>
        <tbody id="resultadoTabla"></tbody>
      </table>
    </div>
  </article>
  <section class="calc-footer">
    Para entender cómo se calculan las notas, revisa la guía de
    <a href="/guides/calculo_notas">Cálculo de Notas</a>.
  </section>
  <style>
    .calc-root {
      max-width: 700px;
      margin: 2rem auto;
      padding: 1rem;
    }

    .calc-group {
      display: flex;
      flex-direction: column;
      margin-bottom: 1rem;
    }

    article {
      margin-bottom: 2rem;
      padding: 1.2rem;
    }

    .calc-row {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .calc-row .calc-group {
      flex: 1;
      min-width: 140px;
    }

    .calc-block {
      margin-bottom: 1.5rem;
      padding: 1rem;
    }

    .calc-legend {
      font-weight: 600;
      padding: 0 var(--space-sm);
    }

    .calc-btn {
      width: 100%;
      padding: 0.7rem;
      font-weight: 600;
      cursor: pointer;
    }

    th,
    td {
      text-align: center;
    }

    .calc-footer {
      font-size: 0.9rem;
    }
  </style>
  <script>
    const MIN_EXAM = 50;

    const UMBRALES = [
      { nota: 5, min: 91 },
      { nota: 4, min: 81 },
      { nota: 3, min: 71 },
      { nota: 2, min: 60 },
    ];

    function examenNecesario(ponderado, nota) {
      const u = UMBRALES.find(x => x.nota === nota);
      let ex = (u.min - 0.4 * ponderado) / 0.6;
      ex = Math.max(ex, MIN_EXAM);
      ex = Math.floor(ex);
      return ex > 100 ? '-' : ex;
    }

    function renderTabla(ponderado) {
      const tbody = document.getElementById('resultadoTabla');
      tbody.innerHTML = '';
      for (let n = 5; n >= 2; n--) {
        tbody.insertAdjacentHTML('beforeend', `
          <tr>
            <td>${n}</td>
            <td>${examenNecesario(ponderado, n)}</td>
          </tr>
        `);
      }
      document.getElementById('resultados')
        .scrollIntoView({ behavior: 'smooth' });
    }

    btnPonderado.onclick = () => {
      const v = Number(inputPonderado.value);
      if (isNaN(v) || v < 40 || v > 100) {
        alert('Promedio inválido');
        return;
      }
      renderTabla(v);
    };

    btnComponentes.onclick = () => {
      const p1 = Number(notaP1.value);
      const p2 = Number(notaP2.value);
      const pesoPar = Number(pesoParciales.value);

      const t = Number(notaT.value);
      const pesoTareas = Number(pesoT.value);

      const l = Number(notaL.value);
      const pesoLab = Number(pesoL.value);

      if (pesoPar + pesoTareas + pesoLab !== 100) {
        alert('Los pesos deben sumar 100%');
        return;
      }

      const notas = [p1, p2, t, l];
      if (notas.some(n => isNaN(n) || n < 0 || n > 100)) {
        alert('Notas inválidas');
        return;
      }

      const promedioParciales = (p1 + p2) / 2;

      const ponderado =
        promedioParciales * pesoPar +
        t * pesoTareas +
        l * pesoLab;

      renderTabla(ponderado / 100);
    };
  </script>
</main>
{{ end }}
