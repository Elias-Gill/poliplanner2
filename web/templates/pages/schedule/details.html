<style id="styles">
  .mb-1rem {
    margin-bottom: 1rem;
  }

  .subjects-container-box {
    max-height: 60vh;
    overflow-y: auto;
    border: 1px solid var(--color-border);
    border-radius: var(--border-radius);
    background: var(--color-bg);
    padding: 1rem;
  }

  .no-subjects-box {
    text-align: center;
    padding: 2rem;
    background: var(--color-bg);
    border-radius: var(--border-radius);
  }

  #selectedSubjectsPreview {
    flex: 1;
    padding: 1rem;
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--border-radius);
    min-height: 200px;
    display: none;
  }

  #selectedSubjectsList {
    list-style: none;
    padding: 0;
  }

  .subject-item {
    padding: .5rem 0;
    border-bottom: 1px solid var(--color-border);
  }

  .subject-label {
    display: block;
    cursor: pointer;
  }

  .selected-li {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: .5rem;
    margin-bottom: .5rem;
    background: var(--color-bg);
    border-radius: var(--border-radius);
  }

  .remove-subject-btn {
    background: var(--color-bg);
    color: white;
    border: none;
    padding: 0.25rem 0.5rem;
    border-radius: var(--border-radius);
    cursor: pointer;
  }
</style>
<div class="schedule-container">
  <div class="subjects-list-column">
    <div class="mb-1rem">
      <label for="semesterFilter">Filtrar por semestre:</label>
      <select id="semesterFilter">
        <option value="all" selected>Todos los semestres</option>
      </select>
    </div>
    <div class="mb-1rem">
      <label for="subjectSearch">Buscar por materia, profesor y/o sección:</label>
      <input type="text" id="subjectSearch" placeholder="Ej. Física, 2, Juan ...">
    </div>
    {{if .Subjects}}
    <div id="subjectsContainer" class="subjects-container-box"></div>
    {{else}}
    <div class="no-subjects-box">
      <p>No se encontraron materias para esta carrera.</p>
      <p><small>Selecciona otra carrera o verifica la versión del Excel.</small></p>
    </div>
    {{end}}
  </div>
  <section id="selectedSubjectsPreview">
    <h3>Materias seleccionadas</h3>
    <ul id="selectedSubjectsList"></ul>
  </section>
  <section>
    <button type="submit">Crear Horario</button>
  </section>
  {{if .Subjects}}
  <script>
    {
      const subjectsRaw = [
        {{range .Subjects}}
        {
          id: "{{.ID}}",
          subjectName: "{{.SubjectName | js}}",
          section: "{{if .Section}}{{.Section | js}}{{end}}",
          professorTitle: "{{if .TeacherTitle}}{{.TeacherTitle | js}}{{end}}",
          professorFirstName: "{{if .TeacherName}}{{.TeacherName | js}}{{end}}",
          professorLastname: "{{if .TeacherLastname}}{{.TeacherLastname | js}}{{end}}",
          semester: {{.Semester}},
        },
        {{end}}
      ];

      subjectsRaw.sort((a, b) => a.semester - b.semester);

      const subjectsContainer = document.getElementById('subjectsContainer');
      const selectedSubjectsPreview = document.getElementById('selectedSubjectsPreview');
      const selectedSubjectsList = document.getElementById('selectedSubjectsList');
      const searchInput = document.getElementById('subjectSearch');
      const semesterFilter = document.getElementById('semesterFilter');

      const selectedIds = new Set();

      const uniqueSemesters = [...new Set(subjectsRaw.map(s => s.semester))].sort((a, b) => a - b);
      uniqueSemesters.forEach(sem => {
        const opt = document.createElement('option');
        opt.value = sem;
        opt.textContent = "Semestre " + sem;
        semesterFilter.appendChild(opt);
      });

      function matchesFilters(sub) {
        const sem = semesterFilter.value;
        if (sem !== "all" && Number(sem) !== sub.semester) return false;

        const raw = searchInput.value.trim().toLowerCase();
        if (!raw) return true;

        const professorName =
          `${sub.professorTitle || ''} ${sub.professorFirstName || ''} ${sub.professorLastname || ''}`
          .trim()
          .toLowerCase();

        const subject = (sub.subjectName || '').toLowerCase();
        const section = (sub.section || '').toLowerCase();

        const terms = raw.split(',').map(t => t.trim()).filter(Boolean);

        for (const term of terms) {
          const ok =
            subject.includes(term) ||
            professorName.includes(term) ||
            section.includes(term);
          if (!ok) return false;
        }

        return true;
      }

      function renderSubjects() {
        subjectsContainer.innerHTML = '';

        const filtered = subjectsRaw.filter(matchesFilters);

        filtered.forEach(sub => {
          const div = document.createElement('div');
          div.className = 'subject-item';

          const professorName =
            `${sub.professorTitle || ''} ${sub.professorFirstName || ''} ${sub.professorLastname || ''}`.trim();

          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.name = 'subjectIds';
          checkbox.id = 'subject-' + sub.id;
          checkbox.value = sub.id;
          checkbox.checked = selectedIds.has(sub.id);

          checkbox.addEventListener('change', () => {
            if (checkbox.checked) selectedIds.add(sub.id);
            else selectedIds.delete(sub.id);
            renderSelectedSubjects();
          });

          const label = document.createElement('label');
          label.className = 'subject-label';
          label.appendChild(checkbox);

          const info = document.createElement('span');
          info.innerHTML =
            ` <strong>${sub.subjectName}</strong> (Semestre ${sub.semester})<br>` +
            `Sección ${sub.section}<br>` +
            `<small>${professorName || "Sin profesor asignado"}</small>`;

          label.appendChild(info);
          div.appendChild(label);
          subjectsContainer.appendChild(div);
        });
      }

      function renderSelectedSubjects() {
        selectedSubjectsList.innerHTML = '';

        if (selectedIds.size === 0) {
          selectedSubjectsPreview.style.display = 'none';
          return;
        }

        selectedSubjectsPreview.style.display = 'block';

        selectedIds.forEach(id => {
          const sub = subjectsRaw.find(s => s.id === id);
          if (!sub) return;

          const li = document.createElement('li');
          li.className = 'selected-li';

          const professorName =
            `${sub.professorTitle || ''} ${sub.professorFirstName || ''} ${sub.professorLastname || ''}`.trim();

          const info = document.createElement('div');
          info.innerHTML =
            `<strong>${sub.subjectName}</strong> – Sección ${sub.section}<br>` +
            `<small>${professorName || "Sin profesor asignado"}</small>`;

          const btn = document.createElement('button');
          btn.type = 'button';
          btn.textContent = 'X';
          btn.title = 'Quitar materia';
          btn.className = 'remove-subject-btn';

          btn.addEventListener('click', () => {
            selectedIds.delete(id);
            const cb = document.getElementById('subject-' + id);
            if (cb) cb.checked = false;
            renderSelectedSubjects();
          });

          li.appendChild(info);
          li.appendChild(btn);
          selectedSubjectsList.appendChild(li);
        });
      }

      searchInput.addEventListener('input', renderSubjects);
      semesterFilter.addEventListener('change', renderSubjects);

      renderSubjects();
      renderSelectedSubjects();
    }
  </script>
  {{end}}
</div>
